# API Endpoint Constraint Template
# Use: /manifold:m0-init <feature> --template=api
# Covers: REST, GraphQL, or RPC API design and implementation

schema_version: 3
feature: "[CUSTOMIZE: your-api-name]-api"
outcome: "[CUSTOMIZE: e.g., 'RESTful API with <200ms p95 latency and 99.9% uptime']"
phase: INITIALIZED
template: api
template_version: 1

# =============================================================================
# CONSTRAINTS - Customize these for your specific API needs
# =============================================================================

constraints:
  business:
    - id: B1
      type: invariant
      statement: "API must maintain backward compatibility for [CUSTOMIZE: 6] months after deprecation notice"
      rationale: "Client applications need time to migrate; breaking changes cause outages"

    - id: B2
      type: boundary
      statement: "API versioning must be explicit in URL path or header"
      rationale: "Enables gradual migration and multiple concurrent versions"

    - id: B3
      type: goal
      statement: "API should follow [CUSTOMIZE: OpenAPI 3.0] specification"
      rationale: "Enables auto-generated documentation and client SDKs"

  technical:
    - id: T1
      type: boundary
      statement: "Response time must be <[CUSTOMIZE: 200]ms at p95 for read operations"
      rationale: "User-facing applications require responsive APIs"

    - id: T2
      type: boundary
      statement: "Response time must be <[CUSTOMIZE: 1000]ms at p95 for write operations"
      rationale: "Write operations may involve transactions and validation"

    - id: T3
      type: invariant
      statement: "All responses must include standard error format with code, message, and request_id"
      rationale: "Consistent error handling enables debugging and client error handling"

    - id: T4
      type: goal
      statement: "Endpoints should support partial responses via field selection"
      rationale: "Reduces bandwidth and improves mobile performance"

    - id: T5
      type: boundary
      statement: "Request payload must not exceed [CUSTOMIZE: 10]MB"
      rationale: "Prevents memory exhaustion and timeout issues"

  user_experience:
    - id: U1
      type: boundary
      statement: "API documentation must be auto-generated and always current"
      rationale: "Stale documentation causes integration errors"

    - id: U2
      type: goal
      statement: "Error messages should suggest corrective action when possible"
      rationale: "Reduces support burden and improves developer experience"

    - id: U3
      type: boundary
      statement: "Rate limit responses must include retry-after header"
      rationale: "Enables clients to implement proper backoff"

  security:
    - id: S1
      type: invariant
      statement: "All endpoints must require authentication except explicitly public ones"
      rationale: "Prevents unauthorized access to data and functionality"

    - id: S2
      type: invariant
      statement: "API must implement rate limiting at [CUSTOMIZE: 100] requests/minute per client"
      rationale: "Prevents abuse and ensures fair resource allocation"

    - id: S3
      type: boundary
      statement: "Sensitive data must never appear in URLs or logs"
      rationale: "URLs are logged by proxies, browsers, and servers"

    - id: S4
      type: goal
      statement: "API should support CORS with configurable allowed origins"
      rationale: "Enables browser-based clients while maintaining security"

  operational:
    - id: O1
      type: boundary
      statement: "API must support health check endpoint returning status in <[CUSTOMIZE: 50]ms"
      rationale: "Enables load balancer health monitoring and alerting"

    - id: O2
      type: goal
      statement: "Request/response logging should capture timing, status, and request_id"
      rationale: "Enables debugging and performance monitoring"

    - id: O3
      type: boundary
      statement: "API must gracefully handle [CUSTOMIZE: 10x] expected traffic"
      rationale: "Traffic spikes should not cause complete failure"

# =============================================================================
# COMMON TENSIONS - Typical conflicts in API systems
# =============================================================================

tensions:
  - id: TN1
    type: trade_off
    between: [T1, O2]
    description: "Fast responses (T1) vs comprehensive logging (O2)"
    status: resolved
    resolution: "Async logging with sampling for high-volume endpoints; sync for errors"
    priority: 1

  - id: TN2
    type: trade_off
    between: [B1, T3]
    description: "Backward compatibility (B1) vs error format improvements (T3)"
    status: resolved
    resolution: "Error format is versioned; new clients get improved format"
    priority: 2

  - id: TN3
    type: trade_off
    between: [S2, U3]
    description: "Strict rate limiting (S2) vs client experience (U3)"
    status: resolved
    resolution: "Tiered rate limits with burst allowance; generous retry-after windows"
    priority: 3

  - id: TN4
    type: hidden_dependency
    between: [S1, O1]
    description: "Auth required (S1) vs health check unauthenticated (O1)"
    status: resolved
    resolution: "Health endpoint explicitly marked public; returns minimal info"
    priority: 1

# =============================================================================
# REQUIRED TRUTHS - What must be true for API to work
# =============================================================================

anchors:
  required_truths:
    - id: RT-1
      statement: "API can authenticate and authorize incoming requests"
      status: NOT_SATISFIED
      priority: 1
      maps_to_constraints: [S1, S2]

    - id: RT-2
      statement: "API can serialize/deserialize requests and responses"
      status: NOT_SATISFIED
      priority: 1
      maps_to_constraints: [T3, T5]

    - id: RT-3
      statement: "API can route requests to appropriate handlers"
      status: NOT_SATISFIED
      priority: 1
      maps_to_constraints: [B2, T1, T2]

    - id: RT-4
      statement: "API can report its health and operational status"
      status: NOT_SATISFIED
      priority: 2
      maps_to_constraints: [O1, O2]

# =============================================================================
# CUSTOMIZATION NOTES
# =============================================================================

_customization:
  required_changes:
    - "Replace latency thresholds (T1, T2) based on SLA"
    - "Set rate limits (S2) based on expected client behavior"
    - "Configure deprecation window (B1) based on client contracts"
    - "Choose API specification (B3): OpenAPI, GraphQL SDL, gRPC proto"

  optional_additions:
    - "Webhooks for async notifications"
    - "GraphQL subscriptions"
    - "API key management"
    - "Request signing"
    - "Caching headers (ETag, Cache-Control)"

  common_removals:
    - "Remove partial responses (T4) for simple APIs"
    - "Remove CORS (S4) for server-to-server APIs"
    - "Remove versioning (B2) for internal APIs"
