#!/usr/bin/env sh
# Husky pre-commit hook for secret detection and manifold validation
# Satisfies: T1 (< 5s), U1 (clear errors), U2 (graceful skip)
# TN1 Resolution: --staged flag for speed
# TN3 Resolution: CI backstop is the real enforcement
#
# Scans staged files for secrets before allowing commit.
# Validates manifold YAML schemas before allowing commit.

# ============================================================
# SECRET DETECTION (gitleaks)
# ============================================================

# Check if gitleaks is installed
if ! command -v gitleaks >/dev/null 2>&1; then
    echo "Warning: gitleaks not installed - skipping local secret detection"
    echo "  Install: brew install gitleaks (macOS) or see https://github.com/gitleaks/gitleaks"
    echo "  Note: CI will still enforce secret detection on push"
else
    # Run gitleaks on staged files only (fast, satisfies T1)
    if ! gitleaks protect --staged --config .gitleaks.toml --verbose; then
        echo ""
        echo "=========================================="
        echo "  SECRET DETECTED IN STAGED FILES"
        echo "=========================================="
        echo ""
        echo "Options to resolve:"
        echo ""
        echo "  1. RECOMMENDED: Remove the secret and use environment variables"
        echo "     - Move secrets to .env (already in .gitignore)"
        echo "     - Reference via process.env.YOUR_SECRET"
        echo ""
        echo "  2. FALSE POSITIVE: Add pattern to .gitleaks.toml allowlist"
        echo "     - Edit .gitleaks.toml and add to [allowlist] section"
        echo "     - See docs/SECURITY.md for examples"
        echo ""
        echo "  3. EMERGENCY ONLY: git commit --no-verify"
        echo "     - NOT RECOMMENDED - CI will still block on push"
        echo "     - Only use if you need to commit work-in-progress locally"
        echo ""
        echo "See docs/SECURITY.md for detailed guidance."
        echo ""
        exit 1
    fi
fi

# ============================================================
# MANIFOLD SCHEMA VALIDATION
# Satisfies: Schema enforcement at commit time
# Validates both JSON+Markdown and legacy YAML manifold formats
# ============================================================

# Extract unique feature names from staged manifold files
STAGED_MANIFOLD=$(git diff --cached --name-only | grep '^\.manifold/' || true)
FEATURES=""

if [ -n "$STAGED_MANIFOLD" ]; then
    for file in $STAGED_MANIFOLD; do
        base=$(basename "$file")
        feature=""
        case "$base" in
            # Skip auxiliary files (verify results, anchor docs)
            *.verify.json|*.verify.yaml|*.anchor.yaml|*.integrate.yaml)
                ;;
            *.json)
                feature="${base%.json}"
                ;;
            *.yaml)
                feature="${base%.yaml}"
                ;;
            *.md)
                feature="${base%.md}"
                ;;
        esac
        # Add feature if non-empty and not already in list
        if [ -n "$feature" ]; then
            if ! echo "$FEATURES" | grep -qx "$feature"; then
                FEATURES="${FEATURES:+$FEATURES
}$feature"
            fi
        fi
    done
fi

if [ -n "$FEATURES" ]; then
    echo "Validating manifold schemas..."

    VALIDATION_FAILED=0

    echo "$FEATURES" | while IFS= read -r feature; do
        [ -z "$feature" ] && continue

        # Run validation (handles both JSON+MD and YAML formats)
        if ! bun run cli/index.ts validate "$feature" --strict 2>/dev/null; then
            echo "❌ Manifold validation failed: $feature"
            # Write failure flag since we're in a subshell (pipe)
            echo "FAILED" > /tmp/manifold_validate_$$
        fi
    done

    if [ -f /tmp/manifold_validate_$$ ]; then
        rm -f /tmp/manifold_validate_$$
        VALIDATION_FAILED=1
    fi

    if [ $VALIDATION_FAILED -eq 1 ]; then
        echo ""
        echo "=========================================="
        echo "  MANIFOLD SCHEMA VALIDATION FAILED"
        echo "=========================================="
        echo ""
        echo "Fix the schema errors above, then re-stage and commit."
        echo ""
        echo "To see detailed validation errors:"
        echo "  bun run cli/index.ts validate <feature> --all"
        echo ""
        echo "Common issues (JSON+MD format):"
        echo "  - JSON IDs must match Markdown headings (#### B1: Title)"
        echo "  - Constraint IDs: B1, T1, U1, S1, O1 (match prefix to category)"
        echo "  - Tension IDs: TN1, TN2, ... | Required Truth IDs: RT-1, RT-2, ..."
        echo ""
        echo "Common issues (legacy YAML format):"
        echo "  - Constraints use 'statement', not 'description'"
        echo "  - Tensions use 'description', not 'statement'"
        echo ""
        echo "See install/commands/SCHEMA_QUICK_REFERENCE.md for field reference."
        echo ""
        exit 1
    fi

    echo "✅ All manifold schemas valid"
fi
