# Outcome Anchoring for secret-detection
# Generated by /manifold:m3-anchor
#
# Backward reasoning: For the outcome to be achieved, what MUST be true?

feature: secret-detection
outcome: "Secrets never leak into codebase through comprehensive detection at pre-commit, CI, and historical scanning layers"

# ============================================================
# BACKWARD REASONING CHAIN
# ============================================================
#
# OUTCOME: Secrets never leak into codebase
#    ↑
# What must be TRUE for this outcome?
#    ↓
# RT-1: CI blocks PRs with secrets (hard enforcement)
#    ↑
# What must be TRUE for RT-1?
#    ↓
# RT-2: Security workflow exists and runs on PRs
# RT-3: Gitleaks detects secrets in diff
# RT-4: Semgrep provides additional SAST coverage
# RT-5: SARIF integrates with GitHub Security tab
#    ↑
# What must be TRUE for defense-in-depth?
#    ↓
# RT-6: Pre-commit hook catches secrets locally (early feedback)
# RT-7: Historical scan finds existing leaks (remediation)
#    ↑
# What must be TRUE for developer experience?
#    ↓
# RT-8: Configuration allows false positive management
# RT-9: Documentation guides developers

required_truths:
  # ============================================================
  # LAYER 1: CI ENFORCEMENT (Critical Path)
  # ============================================================

  - id: RT-1
    statement: "GitHub Actions security workflow exists and runs on all PRs"
    status: NOT_SATISFIED
    gap: "No .github/workflows/security.yml exists"
    satisfies: [S1, B1]  # PR blocking, no secrets reach main
    evidence:
      - type: file_exists
        path: ".github/workflows/security.yml"
    implementation:
      file: ".github/workflows/security.yml"
      description: "Main security workflow with gitleaks, semgrep, trufflehog jobs"

  - id: RT-2
    statement: "Gitleaks scans PR diffs for 100+ secret patterns"
    status: NOT_SATISFIED
    gap: "Gitleaks action not configured in workflow"
    satisfies: [S5, T4]  # Secret detection, TypeScript support
    evidence:
      - type: content_match
        path: ".github/workflows/security.yml"
        pattern: "gitleaks/gitleaks-action"
    implementation:
      action: "gitleaks/gitleaks-action@v2"
      config: ".gitleaks.toml"

  - id: RT-3
    statement: "Semgrep runs security audit and secrets rules"
    status: NOT_SATISFIED
    gap: "Semgrep job not configured in workflow"
    satisfies: [S3, T4]  # Security audit, TypeScript support
    evidence:
      - type: content_match
        path: ".github/workflows/security.yml"
        pattern: "semgrep/semgrep"
    implementation:
      configs:
        - "auto"
        - "p/secrets"
        - "p/security-audit"
        - "p/typescript"

  - id: RT-4
    statement: "SARIF output uploads to GitHub Security tab"
    status: NOT_SATISFIED
    gap: "No SARIF upload action in workflow"
    satisfies: [T3, U3]  # SARIF integration, PR comments
    evidence:
      - type: content_match
        path: ".github/workflows/security.yml"
        pattern: "github/codeql-action/upload-sarif"
    implementation:
      action: "github/codeql-action/upload-sarif@v3"
      categories: ["gitleaks", "semgrep"]

  - id: RT-5
    statement: "CI workflow integrates with existing ci.yml"
    status: NOT_SATISFIED
    gap: "ci.yml does not depend on security workflow"
    satisfies: [B2]  # Release velocity (security as gate, not blocker)
    evidence:
      - type: content_match
        path: ".github/workflows/ci.yml"
        pattern: "needs: security"
    implementation:
      modify: ".github/workflows/ci.yml"
      add: "security job dependency"

  # ============================================================
  # LAYER 2: PRE-COMMIT (Early Feedback)
  # ============================================================

  - id: RT-6
    statement: "Pre-commit hook runs gitleaks on staged files"
    status: NOT_SATISFIED
    gap: "No .husky/pre-commit hook exists"
    satisfies: [T1, U1, U2]  # Fast local, clear errors, graceful skip
    evidence:
      - type: file_exists
        path: ".husky/pre-commit"
      - type: content_match
        path: ".husky/pre-commit"
        pattern: "gitleaks protect --staged"
    implementation:
      file: ".husky/pre-commit"
      description: "Husky hook that runs gitleaks --staged with graceful skip"

  # ============================================================
  # LAYER 3: HISTORICAL SCANNING (Remediation)
  # ============================================================

  - id: RT-7
    statement: "Weekly TruffleHog scan checks entire git history"
    status: NOT_SATISFIED
    gap: "No scheduled historical scan configured"
    satisfies: [S2, O1]  # History scanning, weekly reports
    evidence:
      - type: content_match
        path: ".github/workflows/security.yml"
        pattern: "trufflesecurity/trufflehog"
      - type: content_match
        path: ".github/workflows/security.yml"
        pattern: "schedule:"
    implementation:
      action: "trufflesecurity/trufflehog@main"
      trigger: "cron: '0 0 * * 0'"  # Weekly Sunday midnight

  # ============================================================
  # LAYER 4: CONFIGURATION (Maintainability)
  # ============================================================

  - id: RT-8
    statement: "Gitleaks configuration with documented allowlist"
    status: NOT_SATISFIED
    gap: "No .gitleaks.toml configuration file"
    satisfies: [S4, T5]  # Allowlist mechanism, tool stack
    evidence:
      - type: file_exists
        path: ".gitleaks.toml"
      - type: content_match
        path: ".gitleaks.toml"
        pattern: "\\[allowlist\\]"
    implementation:
      file: ".gitleaks.toml"
      sections:
        - "useDefault = true"
        - "paths exclusions (node_modules, tests)"
        - "documented false positive patterns"

  # ============================================================
  # LAYER 5: DOCUMENTATION (Developer Experience)
  # ============================================================

  - id: RT-9
    statement: "SECURITY.md documents tool usage and false positive handling"
    status: NOT_SATISFIED
    gap: "No docs/SECURITY.md documentation"
    satisfies: [U4, O4]  # False positive docs, developer guide
    evidence:
      - type: file_exists
        path: "docs/SECURITY.md"
    implementation:
      file: "docs/SECURITY.md"
      sections:
        - "Tool installation (gitleaks)"
        - "Handling detected secrets"
        - "False positive management"
        - "Emergency override (discouraged)"

# ============================================================
# SOLUTION OPTIONS
# ============================================================

solution_options:
  - id: A
    name: "Full Implementation"
    description: "Implement all 9 required truths with complete defense-in-depth"
    satisfies_all: true
    artifacts:
      - ".gitleaks.toml"
      - ".husky/pre-commit"
      - ".github/workflows/security.yml"
      - ".github/workflows/ci.yml (modify)"
      - "docs/SECURITY.md"
    complexity: medium
    recommendation: true
    rationale: |
      All invariants (B1, S1, T4, U2) require complete implementation.
      Partial solutions would leave gaps in the defense-in-depth strategy.
      Each layer serves a distinct purpose:
      - Pre-commit: Developer convenience (early feedback)
      - CI: Hard enforcement (invariant guarantee)
      - Historical: Remediation (find existing leaks)

  - id: B
    name: "CI-Only (Minimal)"
    description: "Only implement CI scanning, skip pre-commit and historical"
    satisfies: [RT-1, RT-2, RT-3, RT-4, RT-5, RT-8]
    gaps: [RT-6, RT-7, RT-9]
    artifacts:
      - ".gitleaks.toml"
      - ".github/workflows/security.yml"
      - ".github/workflows/ci.yml (modify)"
    complexity: low
    recommendation: false
    rationale: |
      Satisfies B1 invariant (CI blocks secrets) but misses:
      - RT-6: No early local feedback (developer experience)
      - RT-7: No historical scanning (existing secrets undetected)
      - RT-9: No documentation (onboarding friction)

  - id: C
    name: "Phased Rollout"
    description: "Start with CI (warning mode), add enforcement after stabilization"
    satisfies: [RT-1, RT-2, RT-3, RT-4, RT-5, RT-8]
    gaps: "Enforcement delayed"
    artifacts:
      - ".gitleaks.toml"
      - ".github/workflows/security.yml (warning mode)"
      - "Phase 2: enforcement + pre-commit + docs"
    complexity: low-to-medium
    recommendation: false
    rationale: |
      Lower risk rollout but B1 invariant is violated during warning phase.
      Not recommended for security-critical invariants.

selected_option: A
selection_rationale: |
  B1 (no secrets reach main) is an INVARIANT - it cannot be partially satisfied.
  Option A is the only option that fully satisfies all invariants:
  - B1: No secrets reach main (via S1 CI blocking)
  - S1: Block PR merge (via RT-1, RT-2, RT-3, RT-4)
  - T4: TypeScript support (Gitleaks + Semgrep both support it)
  - U2: Graceful degradation (RT-6 pre-commit skips if gitleaks not installed)

  The defense-in-depth layers complement each other:
  - Layer 1 (CI): GUARANTEES no secrets merge (hard block)
  - Layer 2 (Pre-commit): Saves time by catching early (convenience)
  - Layer 3 (Historical): Finds past mistakes (remediation)
